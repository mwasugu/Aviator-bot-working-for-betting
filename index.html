<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aviator Pro Analytics</title>
    <style>
        /* --- GENERAL STYLES --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            margin: 0;
            padding: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .container {
            background-color: #141414;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.8);
            width: 100%;
            max-width: 450px;
            border: 1px solid #333;
        }
        h1 {
            color: #4CAF50;
            text-align: center;
            margin-bottom: 20px;
            font-size: 24px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* --- INPUTS & BUTTONS --- */
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #888; }
        
        .input-group {
            display: flex;
            align-items: center;
            background: #252525;
            border-radius: 8px;
            padding: 5px;
            border: 1px solid #333;
            margin-bottom: 15px;
        }
        input {
            flex: 1;
            padding: 12px;
            border: none;
            background: transparent;
            color: #fff;
            font-size: 20px;
            font-weight: bold;
            text-align: center;
            outline: none;
        }
        /* Mic Button Styling */
        #micBtn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background-color: #2196F3;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 5px;
            transition: transform 0.2s;
        }
        #micBtn:active { transform: scale(0.9); }

        .main-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            text-transform: uppercase;
            transition: opacity 0.2s;
            margin-bottom: 15px;
        }
        .main-btn:active { opacity: 0.8; }
        #logButton { background-color: #4CAF50; color: #000; }
        #undoButton { background-color: #FF9800; color: #000; }
        #resetButton { background-color: #F44336; color: #fff; }

        /* --- DISPLAYS --- */
        #clockDisplay {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }
        #realTimeDisplay { font-size: 32px; font-weight: bold; display: block; }
        #cycleTimeDisplay { font-size: 16px; color: #888; }

        /* --- ALERTS & RESULTS --- */
        .result-box { margin-top: 5px; }
        
        /* 1. Risk Assessment Box */
        #riskAssessment {
            background-color: #222;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            text-align: center;
            font-size: 16px;
            font-weight: bold;
            border-left: 5px solid #555;
        }

        /* 2. Jackpot Alert Box (Special) */
        #jackpotAlertDisplay {
            background-color: #1a1a1a;
            color: #555;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            font-size: 14px;
            margin-bottom: 15px;
            border: 1px dashed #333;
            min-height: 20px;
        }
        
        /* Animation for Jackpot Hit */
        @keyframes pulse-green {
            0% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7); transform: scale(1); }
            70% { box-shadow: 0 0 0 10px rgba(76, 175, 80, 0); transform: scale(1.02); }
            100% { box-shadow: 0 0 0 0 rgba(76, 175, 80, 0); transform: scale(1); }
        }
        .jackpot-active {
            background-color: #2E7D32 !important;
            color: white !important;
            border: 2px solid #4CAF50 !important;
            animation: pulse-green 1.5s infinite;
            font-size: 16px !important;
            font-weight: bold;
        }

        /* --- HISTORY & FOOTER --- */
        #learningStatusTop {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-bottom: 15px;
        }
        .control-row { display: flex; gap: 10px; }
        
        #historyLog {
            background: #111;
            padding: 10px;
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #333;
        }
        .history-item {
            padding: 8px;
            border-bottom: 1px solid #222;
            font-size: 14px;
            display: flex;
            justify-content: space-between;
        }
        /* Zone Colors */
        .z-red { color: #FF5252; }
        .z-green { color: #69F0AE; }
        .z-orange { color: #FFAB40; font-weight: bold; }

        /* Toggle Switch */
        .toggle-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
            color: #aaa;
            margin-bottom: 15px;
        }
        .switch { position: relative; display: inline-block; width: 40px; height: 22px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #555; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #2196F3; }
        input:checked + .slider:before { transform: translateX(18px); }
    </style>
</head>
<body>
    <div class="container">
        <h1>Aviator Pro Analytics</h1>

        <div id="clockDisplay">
            <span id="realTimeDisplay">--:--:--</span>
            <span id="cycleTimeDisplay">Cycle: 00:00</span>
        </div>
        
        <label>Weka Matokeo (Multiplier):</label>
        <div class="input-group">
            <input type="number" id="roundInput" step="0.01" placeholder="0.00" inputmode="decimal">
            <button id="micBtn">ðŸŽ¤</button>
        </div>

        <div class="toggle-container">
            <span>Auto-Log kwa Sauti:</span>
            <label class="switch">
              <input type="checkbox" id="autoLogToggle" checked>
              <span class="slider"></span>
            </label>
        </div>
        
        <button id="logButton" class="main-btn">LOG ROUND</button>

        <div class="result-box">
            <div id="riskAssessment">Kusanya data kwanza...</div>
            
            <div id="jackpotAlertDisplay">Kusubiri data za Jackpot...</div>
            
            <div class="message" id="systemMessage" style="text-align:center; color:#666; font-size:12px; margin-top:5px;">Tayari kwa data.</div>
        </div>
        
        <div id="learningStatusTop">Raundi: 0 | Makosa: 0</div>

        <div class="control-row">
            <button id="undoButton" class="main-btn" style="width: 50%;">UNDO</button>
            <button id="resetButton" class="main-btn" style="width: 50%;">RESET</button>
        </div>
        
        <div id="historyLog">
            <div style="color:#444; text-align:center; padding:10px;">Historia itaonekana hapa</div>
        </div>
    </div>

    <script>
        // --- ðŸ”’ SECURE INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {

            // --- CONFIGURATION ---
            const CYCLE_SECONDS = 720; // 12 Minutes
            
            // --- STATE MANAGEMENT ---
            let totalRounds = parseInt(localStorage.getItem('avi_total') || 0);
            let errors = parseInt(localStorage.getItem('avi_errors') || 0);
            let history = JSON.parse(localStorage.getItem('avi_history') || '[]');
            
            // --- DOM ELEMENTS ---
            const roundInput = document.getElementById('roundInput'); 
            const logButton = document.getElementById('logButton'); 
            const undoButton = document.getElementById('undoButton');
            const resetButton = document.getElementById('resetButton');
            const micBtn = document.getElementById('micBtn'); 
            const autoLogToggle = document.getElementById('autoLogToggle'); 
            
            const realTimeDisplay = document.getElementById('realTimeDisplay'); 
            const cycleTimeDisplay = document.getElementById('cycleTimeDisplay'); 
            const systemMsg = document.getElementById('systemMessage');
            const statusDisplay = document.getElementById('learningStatusTop');
            const historyLog = document.getElementById('historyLog');
            const riskDisplay = document.getElementById('riskAssessment');
            const jackpotDisplay = document.getElementById('jackpotAlertDisplay');

            // --- HELPERS ---
            function formatTime(date) {
                return date.toTimeString().split(' ')[0];
            }

            function getCycleTime(seconds) {
                const m = Math.floor(seconds / 60).toString().padStart(2, '0');
                const s = (seconds % 60).toString().padStart(2, '0');
                return `${m}:${s}`;
            }

            function getZone(val) {
                if (val >= 10.00) return { name: 'Jackpot', class: 'z-orange' };
                if (val >= 2.00) return { name: 'Green', class: 'z-green' };
                return { name: 'Blue/Red', class: 'z-red' };
            }

            // --- CORE: UPDATE UI ---
            function updateUI() {
                // Update Status Text
                statusDisplay.textContent = `Raundi: ${totalRounds} | Makosa: ${errors}`;
                
                // Render History
                if (history.length === 0) {
                    historyLog.innerHTML = '<div style="color:#444; text-align:center; padding:10px;">Historia itaonekana hapa</div>';
                } else {
                    historyLog.innerHTML = history.map((item, index) => {
                        const zone = getZone(item.val);
                        return `<div class="history-item">
                            <span>#${item.id} [${item.time}]</span>
                            <span class="${zone.class}">${item.val.toFixed(2)}x</span>
                        </div>`;
                    }).join('');
                }

                // Update Buttons State
                undoButton.disabled = history.length === 0;
                
                // Check Toggle
                const savedToggle = localStorage.getItem('avi_autolog');
                autoLogToggle.checked = (savedToggle === 'true' || savedToggle === null);
            }

            // --- LOGIC 1: RISK ASSESSMENT (TREND ANALYSIS) ---
            function runRiskAnalysis() {
                if (history.length < 5) {
                    riskDisplay.textContent = "Data haitoshi kwa uchambuzi (Weka 5+)";
                    riskDisplay.style.backgroundColor = "#222";
                    riskDisplay.style.borderLeft = "5px solid #555";
                    return;
                }

                // Analyze LAST 10 ROUNDS only
                const recentHistory = history.slice(0, 10); 
                let redCount = 0;

                recentHistory.forEach(item => {
                    if (item.val < 2.00) redCount++;
                });

                // Logic: 5+ Red in last 10 is High Risk
                if (redCount >= 5) {
                    riskDisplay.innerHTML = `HATARI KUBWA (HIGH RISK)<br><span style="font-size:12px; font-weight:normal;">${redCount}/10 zimekuwa chini ya 2.00x. Punguza dau.</span>`;
                    riskDisplay.style.backgroundColor = "#3b1010"; // Dark Red
                    riskDisplay.style.borderLeft = "5px solid #FF5252";
                } else if (redCount >= 3) {
                    riskDisplay.innerHTML = `HATARI YA KAWAIDA (MODERATE)<br><span style="font-size:12px; font-weight:normal;">${redCount}/10 ni ndogo. Kuwa makini.</span>`;
                    riskDisplay.style.backgroundColor = "#3b2e10"; // Dark Orange
                    riskDisplay.style.borderLeft = "5px solid #FFAB40";
                } else {
                    riskDisplay.innerHTML = `HALI SHWARI (LOW RISK)<br><span style="font-size:12px; font-weight:normal;">Soko linaenda vizuri (${redCount}/10 Reds).</span>`;
                    riskDisplay.style.backgroundColor = "#103b1a"; // Dark Green
                    riskDisplay.style.borderLeft = "5px solid #69F0AE";
                }
            }

            // --- LOGIC 2: JACKPOT PREDICTION (CYCLE GAP) ---
            function runJackpotPrediction(currentCycleSeconds) {
                const jackpots = history.filter(h => h.val >= 10.00);

                if (jackpots.length < 2) {
                    jackpotDisplay.textContent = "Nasubiri Jackpot 2+ ili kutabiri mzunguko...";
                    jackpotDisplay.className = ""; // Remove alert classes
                    return;
                }

                // Get Cycle Times of last 3 Jackpots
                const lastJackpots = jackpots.slice(0, 3);
                let gaps = [];
                
                for (let i = 0; i < lastJackpots.length - 1; i++) {
                    let newer = lastJackpots[i].cycleSec;
                    let older = lastJackpots[i+1].cycleSec;
                    
                    // Calculate gap handling 720s wrap around
                    let gap = newer - older;
                    if (gap < 0) gap += CYCLE_SECONDS;
                    gaps.push(gap);
                }

                // Average Gap
                const avgGap = gaps.reduce((a, b) => a + b, 0) / gaps.length;
                
                // Predict Next Time
                const lastJackpotTime = lastJackpots[0].cycleSec;
                const predictedNextTime = (lastJackpotTime + avgGap) % CYCLE_SECONDS;
                
                // Check difference between NOW and PREDICTED
                let timeDiff = predictedNextTime - currentCycleSeconds;
                if (timeDiff < 0) timeDiff += CYCLE_SECONDS; // Always look forward

                // Display Logic
                if (timeDiff <= 45 || timeDiff >= (CYCLE_SECONDS - 10)) {
                    // Alert active if within 45 seconds
                    jackpotDisplay.innerHTML = `ðŸš€ JACKPOT INAKUJA!<br>Eneo la Mzunguko: ${getCycleTime(predictedNextTime)}<br>(Iko ndani ya sekunde ${Math.round(timeDiff)})`;
                    jackpotDisplay.className = "jackpot-active";
                } else {
                    jackpotDisplay.innerHTML = `Jackpot Inayofuata: Mzunguko ${getCycleTime(predictedNextTime)}<br><span style="color:#666">(Bado sekunde ${Math.round(timeDiff)})</span>`;
                    jackpotDisplay.className = ""; // Remove alert
                    jackpotDisplay.style.backgroundColor = "#1a1a1a";
                    jackpotDisplay.style.color = "#555";
                }
            }

            // --- CLOCK LOOP ---
            function tick() {
                const now = new Date();
                const totalSec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
                const cycleSec = totalSec % CYCLE_SECONDS;

                realTimeDisplay.textContent = formatTime(now);
                cycleTimeDisplay.textContent = `Mzunguko: ${getCycleTime(cycleSec)}`;

                // Run Analysis continuously
                runJackpotPrediction(cycleSec);
                runRiskAnalysis();
            }

            // --- ACTIONS ---
            function handleLog() {
                const val = parseFloat(roundInput.value);
                if (isNaN(val) || val < 1) {
                    systemMsg.textContent = "Weka namba sahihi (1.00+)";
                    return;
                }

                totalRounds++;
                const now = new Date();
                const totalSec = now.getHours() * 3600 + now.getMinutes() * 60 + now.getSeconds();
                
                const newEntry = {
                    id: totalRounds,
                    val: val,
                    time: formatTime(now),
                    cycleSec: totalSec % CYCLE_SECONDS
                };

                history.unshift(newEntry); // Add to top
                if (history.length > 100) history.pop(); // Limit history

                // Save
                localStorage.setItem('avi_total', totalRounds);
                localStorage.setItem('avi_history', JSON.stringify(history));
                
                roundInput.value = "";
                systemMsg.textContent = `Imerekodiwa: ${val}x`;
                updateUI();
            }

            function handleUndo() {
                if (history.length === 0) return;
                const removed = history.shift();
                if (totalRounds > 0) totalRounds--;
                errors++;
                
                localStorage.setItem('avi_total', totalRounds);
                localStorage.setItem('avi_errors', errors);
                localStorage.setItem('avi_history', JSON.stringify(history));
                
                roundInput.value = removed.val; // Return value to input
                systemMsg.textContent = `Umerudisha: ${removed.val}x`;
                updateUI();
            }

            function handleReset() {
                if(confirm("Futa data zote na anza upya?")) {
                    localStorage.clear();
                    totalRounds = 0;
                    errors = 0;
                    history = [];
                    updateUI();
                    systemMsg.textContent = "Mfumo umerudiwa upya.";
                }
            }

            // --- EVENTS ---
            logButton.addEventListener('click', handleLog);
            undoButton.addEventListener('click', handleUndo);
            resetButton.addEventListener('click', handleReset);
            
            autoLogToggle.addEventListener('change', () => {
                localStorage.setItem('avi_autolog', autoLogToggle.checked);
            });

            // --- VOICE (SIMPLE & ROBUST) ---
            if (window.webkitSpeechRecognition || window.SpeechRecognition) {
                const SpeechApi = window.webkitSpeechRecognition || window.SpeechRecognition;
                const recognition = new SpeechApi();
                recognition.lang = 'en-US'; // English for numbers is usually better detection
                recognition.continuous = false;

                micBtn.addEventListener('click', () => {
                    systemMsg.textContent = "Inasikiliza...";
                    micBtn.style.backgroundColor = "red";
                    recognition.start();
                });

                recognition.onresult = (e) => {
                    micBtn.style.backgroundColor = "#2196F3";
                    const text = e.results[0][0].transcript;
                    const num = text.match(/(\d+(\.\d+)?)/); // Find number
                    
                    if (num) {
                        roundInput.value = parseFloat(num[0]).toFixed(2);
                        if (autoLogToggle.checked) {
                            handleLog();
                            systemMsg.textContent = `Sauti: ${num[0]}x (Imetumwa)`;
                        } else {
                            systemMsg.textContent = `Sauti: ${num[0]}x (Bonyeza LOG)`;
                        }
                    } else {
                        systemMsg.textContent = "Sikusikia namba. Jaribu tena.";
                    }
                };
                
                recognition.onerror = () => {
                    micBtn.style.backgroundColor = "#2196F3";
                    systemMsg.textContent = "Kosa la sauti. Tumia kibodi.";
                };
                
                recognition.onend = () => {
                    micBtn.style.backgroundColor = "#2196F3";
                };
            } else {
                micBtn.style.display = 'none'; // Hide if not supported
            }

            // --- START ---
            setInterval(tick, 1000);
            updateUI();
            tick(); // Run once immediately
        });
    </script>
</body>
</html>
